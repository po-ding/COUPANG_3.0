<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš´ì†¡ ê¸°ë¡ë¶€ (í†µí•©ë³¸)</title>
    <link rel="stylesheet" href="style.css">
    <script src='https://unpkg.com/tesseract.js@v4.1.1/dist/tesseract.min.js'></script>
    <style>
        /* ì¶”ê°€ì ì¸ ìŠ¤íƒ€ì¼ ë³´ì • */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">

        <div class="page-nav">
            <h1 class="logo">cargo<span class="logo-point">note</span></h1>
            <div class="nav-buttons">
                <button type="button" id="refresh-btn">ğŸ”„</button>
                <button type="button" id="back-to-main-btn" class="hidden">â†</button>
                <button type="button" id="go-to-settings-btn">âš™ï¸</button>
            </div>
        </div>
        
        <div id="edit-mode-indicator" class="hidden">
            <span>âš ï¸ ê¸°ë¡ ìˆ˜ì • ì¤‘ (ì‹œê°„ ë³€ê²½ ë¶ˆê°€)</span>
        </div>

        <div id="main-page">
            <form id="record-form" onsubmit="return false;">
                <fieldset id="datetime-info-fieldset">
                    <legend>ê¸°ë¡ ì¼ì‹œ</legend>
                    <div class="input-group row">
                        <input type="date" id="date" required>
                        <input type="time" id="time" required>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>ê¸°ë¡ ì¢…ë¥˜</legend>
                    <select id="type">
                        <option value="í™”ë¬¼ìš´ì†¡">í™”ë¬¼ìš´ì†¡</option>
                        <option value="ìˆ˜ì…">ìˆ˜ì…</option>
                        <option value="ì£¼ìœ ì†Œ">ì£¼ìœ ì†Œ</option>
                        <option value="ì†Œëª¨í’ˆ">ì†Œëª¨í’ˆ</option>
                        <option value="ì§€ì¶œ">ì§€ì¶œ</option>
                    </select>
                </fieldset>

                <fieldset id="transport-details">
                    <legend>ìƒ/í•˜ì°¨ ì •ë³´</legend>
                    <div class="input-group">
                        <!-- ìƒì°¨ì§€ ì…ë ¥ ì„¹ì…˜ -->
                        <div class="location-container">
                            <input type="text" id="from-center" list="center-list" placeholder="ìƒì°¨ì§€ ê²€ìƒ‰/ì…ë ¥">
                            <div id="top-from-centers" class="quick-btn-row"></div>
                        </div>
                        <!-- í•˜ì°¨ì§€ ì…ë ¥ ì„¹ì…˜ -->
                        <div class="location-container">
                            <input type="text" id="to-center" list="center-list" placeholder="í•˜ì°¨ì§€ ê²€ìƒ‰/ì…ë ¥">
                            <div id="top-to-centers" class="quick-btn-row"></div>
                        </div>
                    </div>
                    <datalist id="center-list"></datalist>
                    
                    <div id="address-display" class="note"></div>
                    <input type="number" id="manual-distance" placeholder="ìš´í–‰ê±°ë¦¬(km)">
                </fieldset>

                <fieldset id="fuel-details" class="hidden">
                    <legend>ì£¼ìœ  ì •ë³´</legend>
                    <div class="input-group row">
                        <input type="number" step="0.01" id="fuel-unit-price" placeholder="ë‹¨ê°€ (ì›/L)">
                        <input type="number" step="0.01" id="fuel-liters" placeholder="ì£¼ìœ ëŸ‰ (L)">
                    </div>
                     <select id="fuel-brand">
                        <option value="S-OIL">S-OIL</option>
                        <option value="SKì—ë„ˆì§€">SKì—ë„ˆì§€</option>
                        <option value="GSì¹¼í…ìŠ¤">GSì¹¼í…ìŠ¤</option>
                        <option value="í˜„ëŒ€ì˜¤ì¼ë±…í¬">í˜„ëŒ€ì˜¤ì¼ë±…í¬</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                     </select>
                </fieldset>

                <fieldset id="expense-details" class="hidden">
                    <legend id="expense-legend">ë‚´ì—­ ì…ë ¥</legend>
                    <input type="text" id="expense-item" list="expense-list" placeholder="ë‚´ì—­ (ì‹ëŒ€, í†µí–‰ë£Œ, ê¸°íƒ€ìˆ˜ì… ë“±)">
                    <datalist id="expense-list"></datalist>
                </fieldset>

                <fieldset id="supply-details" class="hidden">
                    <legend>ì†Œëª¨í’ˆ ë‚´ì—­</legend>
                    <input type="text" id="supply-item" placeholder="í’ˆëª© (ì—”ì§„ì˜¤ì¼ ë“±)">
                    <input type="number" id="supply-mileage" placeholder="êµì²´ ì‹œì  ì£¼í–‰ê±°ë¦¬(km)">
                </fieldset>

                <fieldset id="cost-info-fieldset">
                    <legend>ê¸ˆì•¡ ì •ë³´</legend>
                    <div id="cost-wrapper" class="hidden">
                        <input type="number" id="cost" step="0.01" placeholder="ì§€ì¶œ ê¸ˆì•¡ (ë§Œì›)">
                    </div>
                    <div id="income-wrapper">
                        <input type="number" id="income" step="0.01" placeholder="ìˆ˜ì… ê¸ˆì•¡ (ë§Œì›)">
                    </div>
                </fieldset>

                <!-- ë²„íŠ¼ ìˆœì„œ: ë“±ë¡ -> ì‹œì‘ -> ì¢…ë£Œ -> ì·¨ì†Œ -->
                <div id="trip-actions" class="action-btn-group">
                    <button type="button" id="btn-register-trip" style="background-color: #28a745;">ìš´í–‰ ë“±ë¡</button>
                    <button type="button" id="btn-start-trip">ìš´í–‰ ì‹œì‘</button>
                    <button type="button" id="btn-end-trip" style="background-color: #dc3545;">ìš´í–‰ ì¢…ë£Œ</button>
                    <button type="button" id="btn-trip-cancel" style="background-color: #6c757d;">ìš´í–‰ ì·¨ì†Œ</button>
                </div>

                <div id="general-actions" class="action-btn-group hidden">
                    <button type="button" id="btn-save-general">ê¸°ë¡ ì €ì¥</button>
                </div>

                <div id="edit-actions" class="action-btn-group hidden">
                    <div style="display:flex; flex-direction:column; gap:5px; width:100%;">
                        <!-- ìˆ˜ì • ëª¨ë“œ: ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ì—…ë°ì´íŠ¸ ë²„íŠ¼ -->
                        <div style="display:flex; gap:5px; width:100%;">
                            <button type="button" id="btn-edit-start-trip" style="background-color: #007bff; flex:1;">í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ìš´í–‰ ì‹œì‘</button>
                            <button type="button" id="btn-edit-end-trip" style="background-color: #17a2b8; flex:1;">í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ìš´í–‰ ì¢…ë£Œ</button>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button type="button" id="btn-update-record" class="edit-btn">ìˆ˜ì • ì™„ë£Œ</button>
                            <button type="button" id="btn-delete-record" class="delete-btn">ì‚­ì œ</button>
                            <button type="button" id="btn-cancel-edit">ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="edit-id">
            </form>

            <div class="view-section">
                <h2>ê¸°ë¡ ì¡°íšŒ</h2>
                <div class="view-tabs">
                    <button type="button" class="tab-btn active" data-view="today">ì˜¤ëŠ˜</button>
                    <button type="button" class="tab-btn" data-view="daily">ì¼ë³„</button>
                    <button type="button" class="tab-btn" data-view="weekly">ì£¼ë³„</button>
                    <button type="button" class="tab-btn" data-view="monthly">ì›”ë³„</button>
                </div>

                <div id="today-view" class="view-content active">
                    <div class="selector-group">
                        <button type="button" id="prev-day-btn">â†</button>
                        <input type="date" id="today-date-picker">
                        <button type="button" id="next-day-btn">â†’</button>
                    </div>
                    <div id="today-summary" class="summary"></div>
                    <table id="today-records-table" class="responsive-table auto-layout">
                        <thead>
                            <tr>
                                <th>ì‹œì‘</th>
                                <th>ì¢…ë£Œ</th>
                                <th>ì†Œìš”</th>
                                <th>ìƒì°¨</th>
                                <th>í•˜ì°¨</th>
                                <th>ë¹„ê³ </th>
                                <th>ê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div id="daily-view" class="view-content">
                    <div class="selector-group">
                        <select id="daily-year-select"></select>
                        <select id="daily-month-select"></select>
                    </div>
                    <div id="daily-summary" class="summary"></div>
                    <table id="daily-summary-table" class="yearly-summary-table">
                        <thead><tr><th>ì¼</th><th>ìˆ˜ì…</th><th>ì§€ì¶œ</th><th>ì •ì‚°</th><th>ê±°ë¦¬</th><th>ì´ë™</th><th>ì†Œìš”</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="weekly-view" class="view-content">
                    <div class="selector-group">
                        <select id="weekly-year-select"></select>
                        <select id="weekly-month-select"></select>
                    </div>
                    <div id="weekly-summary" class="summary"></div>
                    <table id="weekly-summary-table" class="yearly-summary-table">
                        <thead><tr><th>ì£¼ì°¨</th><th>ê¸°ê°„</th><th>ìˆ˜ì…</th><th>ì§€ì¶œ</th><th>ì •ì‚°</th><th>ê±°ë¦¬</th><th>ì´ë™</th><th>ì†Œìš”</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="monthly-view" class="view-content">
                     <div class="selector-group">
                        <select id="monthly-year-select"></select>
                    </div>
                    <div id="monthly-yearly-summary" class="summary"></div>
                    <table id="monthly-summary-table" class="yearly-summary-table">
                        <thead><tr><th>ì›”</th><th>ìˆ˜ì…</th><th>ì§€ì¶œ</th><th>ì •ì‚°</th><th>ê±°ë¦¬</th><th>ì´ë™</th><th>ì†Œìš”</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
        </div>

        <div id="settings-page" class="hidden">
            <div class="data-summary-section">
                <h2>ë°ì´í„° ìš”ì•½</h2>
                <div id="current-month-summary-container">
                    <h4 id="current-month-title"></h4>
                    <div class="summary-grid" id="month-summary-grid"></div>
                </div>
                <div id="cumulative-summary-container">
                    <h4>ëˆ„ì  ë°ì´í„°</h4>
                    <div class="summary-grid" id="cumulative-summary-grid"></div>
                </div>
            </div>

            <h2 id="toggle-mileage-management" class="collapsible-header">ì£¼í–‰ê±°ë¦¬ ë³´ì • ë° ìš”ì•½</h2>
            <div id="mileage-management-body" class="collapsible-body hidden">
                <fieldset>
                    <legend>ì£¼í–‰ê±°ë¦¬ ë³´ì • (+/- km)</legend>
                    <div class="input-group">
                        <input type="number" id="mileage-correction" placeholder="ì˜ˆ: -150">
                        <button type="button" id="mileage-correction-save-btn" class="setting-save-btn">ë³´ì •ê°’ ì €ì¥</button>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>ê¸°ê°„ë³„ ìš´í–‰ ê±´ìˆ˜ ìš”ì•½</legend>
                    <div class="selector-group" id="mileage-summary-controls">
                        <button type="button" class="tab-btn active" data-period="monthly">ì›”ë³„</button>
                        <button type="button" class="tab-btn" data-period="weekly">ì£¼ë³„</button>
                    </div>
                    <div id="mileage-summary-cards" class="summary-grid"></div>
                </fieldset>
            </div>

            <h2 id="toggle-center-management" class="collapsible-header">ìš´ì†¡ ì§€ì—­ ê´€ë¦¬</h2>
            <div id="center-management-body" class="collapsible-body hidden">
                <fieldset>
                    <legend>ìƒˆ ì§€ì—­ ì¶”ê°€</legend>
                    <div class="input-group">
                        <input type="text" id="new-center-name" placeholder="ì¶”ê°€í•  ì§€ì—­ ì´ë¦„">
                        <input type="text" id="new-center-address" placeholder="ì£¼ì†Œ (ì„ íƒ)">
                        <input type="text" id="new-center-memo" placeholder="ë©”ëª¨ (ì„ íƒ)">
                        <button type="button" id="add-center-btn">ì¶”ê°€</button>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>ë“±ë¡ëœ ì§€ì—­ ëª©ë¡</legend>
                    <input type="text" id="center-search-input" placeholder="ì§€ì—­ ê²€ìƒ‰..." style="margin-bottom: 0.5em;">
                    <div id="center-list-container"></div>
                </fieldset>
            </div>

            <h2 id="toggle-batch-apply" class="collapsible-header">ìš´ì„ ì¼ê´„ ì ìš©</h2>
            <div id="batch-apply-body" class="collapsible-body hidden">
                <fieldset>
                    <legend>ë¯¸ì •ì‚° êµ¬ê°„ ìš´ì„ ì…ë ¥</legend>
                    <div class="input-group row">
                        <input type="text" id="batch-from-center" list="center-list" placeholder="ìƒì°¨ì§€ ê²€ìƒ‰">
                        <input type="text" id="batch-to-center" list="center-list" placeholder="í•˜ì°¨ì§€ ê²€ìƒ‰">
                    </div>
                    <input type="number" id="batch-income" step="0.01" placeholder="ì ìš©í•  ìš´ì†¡ ìˆ˜ì… (ë§Œì›)">
                    <button type="button" id="batch-apply-btn">ì¼ê´„ ì ìš©í•˜ê¸°</button>
                    <div id="batch-status"></div>
                </fieldset>
            </div>
            
            <h2 id="toggle-subsidy-management" class="collapsible-header">ìœ ê°€ë³´ì¡°ê¸ˆ ê´€ë¦¬</h2>
            <div id="subsidy-management-body" class="collapsible-body hidden">
                <fieldset>
                    <legend>ì›” í•œë„ ì„¤ì •</legend>
                    <div class="input-group">
                        <input type="number" id="subsidy-limit" placeholder="ì›” í•œë„ (L) ì…ë ¥">
                        <button type="button" id="subsidy-save-btn" class="setting-save-btn">ì„¤ì • ì €ì¥</button>
                    </div>
                </fieldset>
                
                <fieldset>
                    <legend>ğŸ“· ì˜ìˆ˜ì¦/ìº¡ì³ ì¸ì‹ (ë² íƒ€)</legend>
                    <div class="input-group">
                        <label for="ocr-input" class="file-upload-btn">ğŸ“· ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ ì„ íƒ</label>
                        <input type="file" id="ocr-input" accept="image/*" class="hidden">
                    </div>
                    <div id="ocr-status" class="note" style="margin-top:5px; text-align:center;"></div>
                    
                    <div id="ocr-result-container" class="hidden" style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px;">
                        <h4>ì¸ì‹ ê²°ê³¼ í™•ì¸</h4>
                        <div class="input-group row">
                            <input type="date" id="ocr-date">
                            <input type="time" id="ocr-time">
                        </div>
                        <div class="input-group row">
                            <input type="number" id="ocr-cost" placeholder="ì£¼ìœ ê¸ˆì•¡ (ì›)">
                            <input type="number" id="ocr-subsidy" placeholder="ë³´ì¡°ê¸ˆì•¡ (ì›)">
                        </div>
                        <div class="input-group row">
                            <input type="number" id="ocr-net-cost" placeholder="ì‹¤ì§€ì¶œ(ì°¨ê°) ê¸ˆì•¡" readonly style="background-color: #f8f9fa; font-weight: bold; color: #007bff;">
                            <input type="number" id="ocr-liters" placeholder="ì£¼ìœ ë¦¬í„° (L)">
                        </div>
                        <div class="input-group row">
                            <input type="number" id="ocr-price" placeholder="ì£¼ìœ ë‹¨ê°€ (ì›)">
                            <input type="number" id="ocr-remaining" placeholder="ì”ì—¬í•œë„ (L) - ì°¸ê³ ìš©">
                        </div>
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button type="button" id="btn-retry-ocr" style="background-color: #6c757d;">ì¬ì¸ì‹</button>
                            <button type="button" id="btn-save-ocr" style="background-color: #28a745;">ì €ì¥í•˜ê¸°</button>
                        </div>
                    </div>
                </fieldset>

                <div id="subsidy-summary" class="subsidy-summary"></div>
                <div id="subsidy-records-container">
                    <h4>ì „ì²´ ì£¼ìœ  ë‚´ì—­</h4>
                    <div id="subsidy-records-list"></div>
                    <div id="subsidy-load-more-container"></div>
                </div>
            </div>

            <h2 id="toggle-print-management" class="collapsible-header">ê¸°ê°„ë³„ ìš´ì†¡ ë‚´ì—­ ì¶œë ¥</h2>
            <div id="print-management-body" class="collapsible-body hidden">
                <fieldset>
                    <legend>ì¡°íšŒ ê¸°ê°„ ì„ íƒ</legend>
                    <div class="selector-group">
                        <select id="print-year-select"></select>
                        <select id="print-month-select"></select>
                    </div>
                    <div class="action-btn-group">
                        <button type="button" id="print-first-half-btn">1~15ì¼ ê°„í¸ ì¶œë ¥</button>
                        <button type="button" id="print-second-half-btn">16~ë§ì¼ ê°„í¸ ì¶œë ¥</button>
                        <button type="button" id="print-full-month-btn">1~ë§ì¼ ê°„í¸ ì¶œë ¥</button>
                    </div>
                    <div class="action-btn-group" style="margin-top: 0.5em;">
                        <button type="button" id="print-first-half-detail-btn">1~15ì¼ ìƒì„¸ ì¶œë ¥</button>
                        <button type="button" id="print-second-half-detail-btn">16~ë§ì¼ ìƒì„¸ ì¶œë ¥</button>
                        <button type="button" id="print-full-month-detail-btn">1~ë§ì¼ ìƒì„¸ ì¶œë ¥</button>
                    </div>
                </fieldset>
            </div>

            <h2 id="toggle-data-management" class="collapsible-header">ë°ì´í„° ê´€ë¦¬</h2>
            <div id="data-management-body" class="collapsible-body hidden">
                <div class="action-buttons">
                    <button type="button" id="export-json-btn">JSON ì €ì¥ (ë°±ì—…)</button>
                    <button type="button" id="import-json-btn">JSON ë³µì›</button>
                    <button type="button" id="clear-btn">ì „ì²´ ë°ì´í„° ì‚­ì œ</button>
                </div>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>

        </div>
    </div>

    <div id="toast-notification"></div>

<script>
/** 
 * [í†µí•© ìŠ¤í¬ë¦½íŠ¸] 
 * ëª¨ë“ˆ import ì˜¤ë¥˜(CORS) ë°©ì§€ë¥¼ ìœ„í•´ ëª¨ë“  JSë¥¼ í•˜ë‚˜ë¡œ í•©ì³¤ìŠµë‹ˆë‹¤.
 */

// ========================
// 1. DATA (data.js)
// ========================
let MEM_RECORDS = [];
let MEM_LOCATIONS = {};
let MEM_FARES = {};
let MEM_CENTERS = [];
let MEM_DISTANCES = {};
let MEM_COSTS = {};
let MEM_EXPENSE_ITEMS = [];

function loadAllData() {
    try {
        const records = JSON.parse(localStorage.getItem('records')) || [];
        MEM_RECORDS = Array.isArray(records) ? records : [];

        const locs = JSON.parse(localStorage.getItem('saved_locations')) || {};
        MEM_LOCATIONS = locs;

        const fares = JSON.parse(localStorage.getItem('saved_fares')) || {};
        MEM_FARES = fares;

        const centers = JSON.parse(localStorage.getItem('logistics_centers')) || [];
        MEM_CENTERS = Array.isArray(centers) ? centers : [];
        if (MEM_CENTERS.length === 0) MEM_CENTERS.push('ì•ˆì„±', 'ì•ˆì‚°', 'ìš©ì¸', 'ì´ì²œ', 'ì¸ì²œ');
        MEM_CENTERS.sort(); 

        const dists = JSON.parse(localStorage.getItem('saved_distances')) || {};
        MEM_DISTANCES = dists;

        const costs = JSON.parse(localStorage.getItem('saved_costs')) || {};
        MEM_COSTS = costs;

        const items = JSON.parse(localStorage.getItem('saved_expense_items')) || [];
        MEM_EXPENSE_ITEMS = Array.isArray(items) ? items : [];

        syncHistoryToAutocompleteDB();
    } catch (e) {
        console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", e);
    }
}

function saveData() {
    MEM_RECORDS.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
    localStorage.setItem('records', JSON.stringify(MEM_RECORDS));
    localStorage.setItem('saved_locations', JSON.stringify(MEM_LOCATIONS));
    localStorage.setItem('saved_fares', JSON.stringify(MEM_FARES));
    
    MEM_CENTERS.sort();
    localStorage.setItem('logistics_centers', JSON.stringify(MEM_CENTERS));
    
    localStorage.setItem('saved_distances', JSON.stringify(MEM_DISTANCES));
    localStorage.setItem('saved_costs', JSON.stringify(MEM_COSTS));
    localStorage.setItem('saved_expense_items', JSON.stringify(MEM_EXPENSE_ITEMS));
}

function updateLocationData(name, address, memo) {
    if (!name) return;
    const trimmed = name.trim();
    if (!MEM_CENTERS.includes(trimmed)) {
        MEM_CENTERS.push(trimmed);
        MEM_CENTERS.sort(); 
    }
    if (address || memo) {
        MEM_LOCATIONS[trimmed] = { 
            ...(MEM_LOCATIONS[trimmed] || {}), 
            address: address || (MEM_LOCATIONS[trimmed]?.address || ''), 
            memo: memo || (MEM_LOCATIONS[trimmed]?.memo || '') 
        };
    }
    saveData();
}

function updateExpenseItemData(item) {
    if (!item) return;
    const trimmed = item.trim();
    if (!MEM_EXPENSE_ITEMS.includes(trimmed)) {
        MEM_EXPENSE_ITEMS.push(trimmed);
        MEM_EXPENSE_ITEMS.sort();
        saveData();
    }
}

function syncHistoryToAutocompleteDB() {
    let updated = false;
    MEM_RECORDS.forEach(r => {
        if (r.type === 'í™”ë¬¼ìš´ì†¡' && r.from && r.to) {
            const key = `${r.from.trim()}-${r.to.trim()}`;
            if (r.income > 0 && !MEM_FARES[key]) { MEM_FARES[key] = r.income; updated = true; }
            if (r.distance > 0 && !MEM_DISTANCES[key]) { MEM_DISTANCES[key] = r.distance; updated = true; }
            if (r.cost > 0 && !MEM_COSTS[key]) { MEM_COSTS[key] = r.cost; updated = true; }
        }
    });
    if (updated) saveData();
}

function addRecord(record) {
    if (record.type === 'í™”ë¬¼ìš´ì†¡' && record.from && record.to) {
        const key = `${record.from}-${record.to}`;
        if(record.income > 0) MEM_FARES[key] = record.income;
        if(record.distance > 0) MEM_DISTANCES[key] = record.distance;
        if(record.cost > 0) MEM_COSTS[key] = record.cost;
    }
    MEM_RECORDS.push(record);
    saveData();
}

function removeRecord(id) {
    const idx = MEM_RECORDS.findIndex(r => r.id === id);
    if(idx > -1) {
        MEM_RECORDS.splice(idx, 1);
        saveData();
    }
}

// ========================
// 2. UTILS (utils.js)
// ========================
const getTodayString = () => {
    const d = new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

const getCurrentTimeString = () => {
    const d = new Date();
    const hours = String(d.getHours()).padStart(2, '0');
    const minutes = String(d.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
};

const formatToManwon = (val) => isNaN(val) ? '0' : Math.round(val / 10000).toLocaleString('ko-KR');

function showToast(msg) {
    const toast = document.getElementById('toast-notification');
    if(toast){
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 1500);
    }
}

function copyTextToClipboard(text, msg) {
    if (!navigator.clipboard) {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); showToast(msg || 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); } 
        catch (e) { console.error(e); }
        document.body.removeChild(ta);
        return;
    }
    navigator.clipboard.writeText(text).then(() => showToast(msg || 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'))
    .catch(err => console.log('ë³µì‚¬ ì‹¤íŒ¨:', err));
}

function getStatisticalDate(dateStr, timeStr) {
    if (!dateStr || !timeStr) return dateStr;
    const hour = parseInt(timeStr.split(':')[0], 10);
    if (hour >= 4) return dateStr;
    const parts = dateStr.split('-'); 
    const y = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10) - 1; 
    const d = parseInt(parts[2], 10);
    const dateObj = new Date(y, m, d, 12, 0, 0);
    dateObj.setDate(dateObj.getDate() - 1); 
    const newY = dateObj.getFullYear();
    const newM = String(dateObj.getMonth() + 1).padStart(2, '0');
    const newD = String(dateObj.getDate()).padStart(2, '0');
    return `${newY}-${newM}-${newD}`;
}

// ========================
// 3. STATS (stats.js)
// ========================
let displayedSubsidyCount = 0;

function safeInt(value) {
    if (!value) return 0;
    const num = parseInt(String(value).replace(/,/g, ''), 10);
    return isNaN(num) ? 0 : num;
}

function safeFloat(value) {
    if (!value) return 0;
    const num = parseFloat(String(value).replace(/,/g, ''));
    return isNaN(num) ? 0 : num;
}

function calculateTotalDuration(records) {
    const sorted = [...records].sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
    let totalMinutes = 0;
    if (sorted.length < 2) return '0h 0m';
    for (let i = 1; i < sorted.length; i++) {
        const curr = new Date(`${sorted[i].date}T${sorted[i].time}`);
        const prev = new Date(`${sorted[i-1].date}T${sorted[i-1].time}`);
        if (sorted[i-1].type !== 'ìš´í–‰ì¢…ë£Œ') {
            totalMinutes += (curr - prev) / 60000;
        }
    }
    const hours = Math.floor(totalMinutes / 60);
    const minutes = Math.round(totalMinutes % 60);
    return `${hours}h ${minutes}m`;
}

function createSummaryHTML(title, records) {
    const validRecords = records.filter(r => r.type !== 'ìš´í–‰ì·¨ì†Œ' && r.type !== 'ìš´í–‰ì¢…ë£Œ');
    let totalIncome = 0, totalExpense = 0, totalDistance = 0, totalTripCount = 0;
    let totalFuelCost = 0, totalFuelLiters = 0;
    
    validRecords.forEach(r => {
        totalIncome += safeInt(r.income);
        totalExpense += safeInt(r.cost);
        if (r.type === 'ì£¼ìœ ì†Œ') { 
            totalFuelCost += safeInt(r.cost); 
            totalFuelLiters += safeFloat(r.liters); 
        }
        if (['í™”ë¬¼ìš´ì†¡'].includes(r.type)) { 
            totalDistance += safeFloat(r.distance); 
            totalTripCount++; 
        }
    });

    const netIncome = totalIncome - totalExpense;
    
    const metrics = [
        { label: 'ìˆ˜ì…', value: formatToManwon(totalIncome), unit: ' ë§Œì›', className: 'income' },
        { label: 'ì§€ì¶œ', value: formatToManwon(totalExpense), unit: ' ë§Œì›', className: 'cost' },
        { label: 'ì •ì‚°', value: formatToManwon(netIncome), unit: ' ë§Œì›', className: 'net' },
        { label: 'ìš´í–‰ê±°ë¦¬', value: totalDistance.toFixed(1), unit: ' km' },
        { label: 'ìš´í–‰ê±´ìˆ˜', value: totalTripCount, unit: ' ê±´' },
        { label: 'ì£¼ìœ ê¸ˆì•¡', value: formatToManwon(totalFuelCost), unit: ' ë§Œì›', className: 'cost' },
        { label: 'ì£¼ìœ ë¦¬í„°', value: totalFuelLiters.toFixed(2), unit: ' L' },
    ];
    let itemsHtml = metrics.map(m => `<div class="summary-item"><span class="summary-label">${m.label}</span><span class="summary-value ${m.className || ''} hidden">${m.value}${m.unit}</span></div>`).join('');
    return `<strong>${title}</strong><div class="summary-toggle-grid" onclick="window.toggleAllSummaryValues(this)">${itemsHtml}</div>`;
}

function displayTodayRecords(date) {
    const todayTbody = document.querySelector('#today-records-table tbody');
    const todaySummaryDiv = document.getElementById('today-summary');
    
    const dayRecords = MEM_RECORDS.filter(r => getStatisticalDate(r.date, r.time) === date)
                                  .sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
    
    if(todayTbody) todayTbody.innerHTML = '';
    const displayList = dayRecords.filter(r => r.type !== 'ìš´í–‰ì¢…ë£Œ');

    displayList.forEach(r => {
        const tr = document.createElement('tr');
        tr.onclick = () => editRecord(r.id);

        let timeDisplay = r.time;
        if(r.date !== date) { 
            timeDisplay = `<span style="font-size:0.8em; color:#888;">(ìµì¼)</span> ${r.time}`;
        }

        let money = '';
        const inc = safeInt(r.income);
        const cst = safeInt(r.cost);

        if(inc > 0) money += `<span class="income">+${formatToManwon(inc)}</span> `;
        if(cst > 0) money += `<span class="cost">-${formatToManwon(cst)}</span>`;
        if(money === '') money = '0'; 

        const isTransport = (r.type === 'í™”ë¬¼ìš´ì†¡' || r.type === 'ëŒ€ê¸°' || r.type === 'ìš´í–‰ì·¨ì†Œ');

        if (isTransport) {
            let endTime = 'ì§„í–‰ì¤‘';
            let duration = '-';

            const idx = MEM_RECORDS.findIndex(item => item.id === r.id);
            if (idx > -1 && idx < MEM_RECORDS.length - 1) {
                const next = MEM_RECORDS[idx + 1];
                if (next.date !== r.date) {
                    const monthDay = next.date.substring(5);
                    endTime = `<span style="font-size:0.8em; color:#888;">(${monthDay})</span><br>${next.time}`;
                } else {
                    endTime = next.time;
                }

                const startObj = new Date(`${r.date}T${r.time}`);
                const endObj = new Date(`${next.date}T${next.time}`);
                const diff = endObj - startObj;
                
                if (diff >= 0) {
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    duration = h > 0 ? `${h}h ${m}m` : `${m}m`;
                }
            }

            const fromVal = (r.from||'').replace(/"/g, '&quot;');
            const toVal = (r.to||'').replace(/"/g, '&quot;');
            
            const fromLoc = MEM_LOCATIONS[r.from] || {};
            const toLoc = MEM_LOCATIONS[r.to] || {};
            
            let fromCell = `<span class="location-clickable" data-center="${fromVal}">${r.from || ''}</span>`;
            if (fromLoc.memo && fromLoc.memo.trim() !== '') {
                fromCell += `<span class="table-memo">${fromLoc.memo}</span>`;
            }
            
            let toCell = `<span class="location-clickable" data-center="${toVal}">${r.to || ''}</span>`;
            if (toLoc.memo && toLoc.memo.trim() !== '') {
                toCell += `<span class="table-memo">${toLoc.memo}</span>`;
            }
            
            let noteCell = '';
            if(r.distance) noteCell = `<span class="note">${safeFloat(r.distance)} km</span>`;
            if(r.type === 'ëŒ€ê¸°') noteCell = `<span class="note">ëŒ€ê¸°ì¤‘</span>`;
            if(r.type === 'ìš´í–‰ì·¨ì†Œ') noteCell = `<span class="note cancelled">ì·¨ì†Œë¨</span>`;

            tr.innerHTML = `
                <td data-label="ì‹œì‘">${timeDisplay}</td>
                <td data-label="ì¢…ë£Œ">${endTime}</td>
                <td data-label="ì†Œìš”">${duration}</td>
                <td data-label="ìƒì°¨">${fromCell}</td>
                <td data-label="í•˜ì°¨">${toCell}</td>
                <td data-label="ë¹„ê³ ">${noteCell}</td>
                <td data-label="ê¸ˆì•¡">${money}</td>
            `;
        } else {
            const detail = r.expenseItem || r.supplyItem || r.brand || '';
            const content = `<span style="font-weight:bold; color:#555;">[${r.type}]</span>&nbsp;&nbsp;${detail}`;
            
            tr.innerHTML = `
                <td data-label="ì‹œì‘">${timeDisplay}</td>
                <td colspan="5" data-label="" style="color:#333;">${content}</td>
                <td data-label="ê¸ˆì•¡">${money}</td>
            `;
        }
        
        if(todayTbody) todayTbody.appendChild(tr);
    });
    if(todaySummaryDiv) todaySummaryDiv.innerHTML = createSummaryHTML('ì˜¤ëŠ˜ì˜ ê¸°ë¡ (04ì‹œ ê¸°ì¤€)', dayRecords);
}

function displaySubsidyRecords(append = false) {
    const subsidyRecordsList = document.getElementById('subsidy-records-list');
    const subsidyLoadMoreContainer = document.getElementById('subsidy-load-more-container');
    const fuelRecords = MEM_RECORDS.filter(r => r.type === 'ì£¼ìœ ì†Œ').sort((a, b) => (b.date + b.time).localeCompare(a.date + a.time));
    
    if (!append) { 
        displayedSubsidyCount = 0; 
        if(subsidyRecordsList) subsidyRecordsList.innerHTML = ''; 
    }
    
    if (fuelRecords.length === 0) { 
        if(subsidyRecordsList) subsidyRecordsList.innerHTML = '<p class="note" style="text-align:center; padding:1em;">ì£¼ìœ  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; 
        if(subsidyLoadMoreContainer) subsidyLoadMoreContainer.innerHTML = ''; 
        return; 
    }
    
    const nextBatch = fuelRecords.slice(displayedSubsidyCount, displayedSubsidyCount + 10);
    nextBatch.forEach(r => {
        const div = document.createElement('div');
        div.className = 'center-item'; 
        div.style.marginBottom = '5px';
        div.innerHTML = `
            <div class="info">
                <span class="center-name">${r.date} <span class="note">(${r.brand || 'ê¸°íƒ€'})</span></span>
                <span style="font-weight:bold;">${formatToManwon(safeInt(r.cost))} ë§Œì›</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:0.9em; color:#555;">
                <span>ì£¼ìœ ëŸ‰: ${parseFloat(r.liters).toFixed(2)} L</span>
                <span>ë‹¨ê°€: ${r.unitPrice} ì›</span>
            </div>`;
        if(subsidyRecordsList) subsidyRecordsList.appendChild(div);
    });
    
    displayedSubsidyCount += nextBatch.length;
    
    if (displayedSubsidyCount < fuelRecords.length && subsidyLoadMoreContainer) { 
        subsidyLoadMoreContainer.innerHTML = '<button class="load-more-btn" style="margin-top:10px; padding:10px;">â–¼ ë” ë³´ê¸°</button>'; 
        subsidyLoadMoreContainer.querySelector('button').onclick = () => displaySubsidyRecords(true); 
    } else if(subsidyLoadMoreContainer) { 
        subsidyLoadMoreContainer.innerHTML = ''; 
    }
}

function displayDailyRecords() {
    const yearSelect = document.getElementById('daily-year-select');
    const monthSelect = document.getElementById('daily-month-select');
    if(!yearSelect || !monthSelect) return;

    const year = yearSelect.value;
    const month = monthSelect.value;
    const selectedPeriod = `${year}-${month}`;
    const dailyTbody = document.querySelector('#daily-summary-table tbody');
    const dailySummaryDiv = document.getElementById('daily-summary');
    const monthRecords = MEM_RECORDS.filter(r => getStatisticalDate(r.date, r.time).startsWith(selectedPeriod));
    
    if(dailyTbody) dailyTbody.innerHTML = '';
    if(dailySummaryDiv) {
        dailySummaryDiv.classList.remove('hidden');
        dailySummaryDiv.innerHTML = createSummaryHTML(`${parseInt(month)}ì›” ì´ê³„ (04ì‹œ ê¸°ì¤€)`, monthRecords);
    }
    const recordsByDate = {};
    monthRecords.forEach(r => {
        const statDate = getStatisticalDate(r.date, r.time);
        if(!recordsByDate[statDate]) recordsByDate[statDate] = { records: [], income: 0, expense: 0, distance: 0, tripCount: 0 };
        recordsByDate[statDate].records.push(r);
    });
    Object.keys(recordsByDate).sort().reverse().forEach(date => {
        const dayData = recordsByDate[date];
        const transport = dayData.records.filter(r => ['í™”ë¬¼ìš´ì†¡', 'ê³µì°¨ì´ë™', 'ëŒ€ê¸°', 'ìš´í–‰ì¢…ë£Œ', 'ìš´í–‰ì·¨ì†Œ'].includes(r.type));
        let inc = 0, exp = 0, dist = 0, count = 0;
        dayData.records.forEach(r => {
            if(r.type !== 'ìš´í–‰ì¢…ë£Œ' && r.type !== 'ìš´í–‰ì·¨ì†Œ') { inc += safeInt(r.income); exp += safeInt(r.cost); }
            if(r.type === 'í™”ë¬¼ìš´ì†¡') { dist += safeFloat(r.distance); count++; }
        });
        if (count === 0) return;
        const tr = document.createElement('tr');
        if(date === getTodayString()) tr.style.fontWeight = 'bold';
        tr.innerHTML = `<td data-label="ì¼">${parseInt(date.substring(8,10))}ì¼</td><td data-label="ìˆ˜ì…"><span class="income">${formatToManwon(inc)}</span></td><td data-label="ì§€ì¶œ"><span class="cost">${formatToManwon(exp)}</span></td><td data-label="ì •ì‚°"><strong>${formatToManwon(inc-exp)}</strong></td><td data-label="ê±°ë¦¬">${dist.toFixed(1)}</td><td data-label="ì´ë™">${count}</td><td data-label="ì†Œìš”">${calculateTotalDuration(transport)}</td><td data-label="ê´€ë¦¬"><button class="edit-btn" onclick="window.viewDateDetails('${date}')">ìƒì„¸</button></td>`;
        if(dailyTbody) dailyTbody.appendChild(tr);
    });
}

function displayWeeklyRecords() {
    const yearSelect = document.getElementById('weekly-year-select');
    const monthSelect = document.getElementById('weekly-month-select');
    if(!yearSelect || !monthSelect) return;

    const year = yearSelect.value;
    const month = monthSelect.value;
    const selectedPeriod = `${year}-${month}`;
    const weeklyTbody = document.querySelector('#weekly-summary-table tbody');
    const weeklySummaryDiv = document.getElementById('weekly-summary');
    const monthRecords = MEM_RECORDS.filter(r => getStatisticalDate(r.date, r.time).startsWith(selectedPeriod));
    
    if(weeklyTbody) weeklyTbody.innerHTML = '';
    if(weeklySummaryDiv) weeklySummaryDiv.innerHTML = createSummaryHTML(`${parseInt(month)}ì›” ì£¼ë³„`, monthRecords);
    
    const weeks = {};
    monthRecords.forEach(r => {
        const statDate = getStatisticalDate(r.date, r.time);
        const d = new Date(statDate);
        const w = Math.ceil((d.getDate() + (new Date(d.getFullYear(), d.getMonth(), 1).getDay())) / 7);
        if(!weeks[w]) weeks[w] = [];
        weeks[w].push(r);
    });
    Object.keys(weeks).forEach(w => {
        const data = weeks[w];
        const transport = data.filter(r => ['í™”ë¬¼ìš´ì†¡', 'ê³µì°¨ì´ë™', 'ëŒ€ê¸°', 'ìš´í–‰ì¢…ë£Œ', 'ìš´í–‰ì·¨ì†Œ'].includes(r.type));
        let inc = 0, exp = 0, dist = 0, count = 0;
        data.forEach(r => { 
            if(r.type!=='ìš´í–‰ì¢…ë£Œ'&&r.type!=='ìš´í–‰ì·¨ì†Œ'){inc+=safeInt(r.income);exp+=safeInt(r.cost);} 
            if(r.type==='í™”ë¬¼ìš´ì†¡'){dist+=safeFloat(r.distance);count++;} 
        });
        const dates = data.map(r => new Date(getStatisticalDate(r.date, r.time)).getDate());
        const tr = document.createElement('tr');
        tr.innerHTML = `<td data-label="ì£¼ì°¨">${w}ì£¼ì°¨</td><td data-label="ê¸°ê°„">${Math.min(...dates)}ì¼~${Math.max(...dates)}ì¼</td><td data-label="ìˆ˜ì…">${formatToManwon(inc)}</td><td data-label="ì§€ì¶œ">${formatToManwon(exp)}</td><td data-label="ì •ì‚°">${formatToManwon(inc-exp)}</td><td data-label="ê±°ë¦¬">${dist.toFixed(1)}</td><td data-label="ì´ë™">${count}</td><td data-label="ì†Œìš”">${calculateTotalDuration(transport)}</td>`;
        if(weeklyTbody) weeklyTbody.appendChild(tr);
    });
}

function displayMonthlyRecords() {
    const yearSelect = document.getElementById('monthly-year-select');
    if(!yearSelect) return;
    const year = yearSelect.value;
    const monthlyTbody = document.querySelector('#monthly-summary-table tbody');
    const monthlyYearlySummaryDiv = document.getElementById('monthly-yearly-summary');
    const yearRecords = MEM_RECORDS.filter(r => getStatisticalDate(r.date, r.time).startsWith(year));
    
    if(monthlyYearlySummaryDiv) monthlyYearlySummaryDiv.innerHTML = createSummaryHTML(`${year}ë…„`, yearRecords);
    if(monthlyTbody) monthlyTbody.innerHTML = '';
    
    const months = {};
    yearRecords.forEach(r => { 
        const statDate = getStatisticalDate(r.date, r.time);
        const m = statDate.substring(0,7); 
        if(!months[m]) months[m]={records:[]}; 
        months[m].records.push(r); 
    });
    Object.keys(months).sort().reverse().forEach(m => {
        const data = months[m];
        const transport = data.records.filter(r => ['í™”ë¬¼ìš´ì†¡', 'ê³µì°¨ì´ë™', 'ëŒ€ê¸°', 'ìš´í–‰ì¢…ë£Œ', 'ìš´í–‰ì·¨ì†Œ'].includes(r.type));
        let inc=0,exp=0,dist=0,count=0;
         data.records.forEach(r => { 
            if(r.type!=='ìš´í–‰ì¢…ë£Œ'&&r.type!=='ìš´í–‰ì·¨ì†Œ'){inc+=safeInt(r.income);exp+=safeInt(r.cost);} 
            if(r.type==='í™”ë¬¼ìš´ì†¡'){dist+=safeFloat(r.distance);count++;} 
        });
        const tr = document.createElement('tr');
        tr.innerHTML = `<td data-label="ì›”">${parseInt(m.substring(5))}ì›”</td><td data-label="ìˆ˜ì…">${formatToManwon(inc)}</td><td data-label="ì§€ì¶œ">${formatToManwon(exp)}</td><td data-label="ì •ì‚°">${formatToManwon(inc-exp)}</td><td data-label="ê±°ë¦¬">${dist.toFixed(1)}</td><td data-label="ì´ë™">${count}</td><td data-label="ì†Œìš”">${calculateTotalDuration(transport)}</td>`;
        if(monthlyTbody) monthlyTbody.appendChild(tr);
    });
}

function displayCurrentMonthData() {
    const now = new Date();
    let checkDate = new Date();
    if(checkDate.getHours() < 4) checkDate.setDate(checkDate.getDate() - 1);
    const currentPeriod = checkDate.toISOString().slice(0, 7); 
    const monthRecords = MEM_RECORDS.filter(r => getStatisticalDate(r.date, r.time).startsWith(currentPeriod) && r.type !== 'ìš´í–‰ì·¨ì†Œ' && r.type !== 'ìš´í–‰ì¢…ë£Œ'); 
    const titleEl = document.getElementById('current-month-title');
    if(titleEl) titleEl.textContent = `${parseInt(currentPeriod.split('-')[1])}ì›” ì‹¤ì‹œê°„ ìš”ì•½ (04ì‹œ ê¸°ì¤€)`; 
    let inc = 0, exp = 0, count = 0, dist = 0, liters = 0; 
    monthRecords.forEach(r => { 
        inc += safeInt(r.income); exp += safeInt(r.cost); 
        if(r.type === 'í™”ë¬¼ìš´ì†¡') { count++; dist += safeFloat(r.distance); } 
        if(r.type === 'ì£¼ìœ ì†Œ') liters += safeFloat(r.liters); 
    }); 
    const days = new Set(monthRecords.map(r => getStatisticalDate(r.date, r.time))).size; 
    const net = inc - exp; 
    const avg = liters > 0 && dist > 0 ? (dist/liters).toFixed(2) : 0; 
    const costKm = dist > 0 ? Math.round(exp/dist) : 0; 
    
    if(document.getElementById('current-month-operating-days')) document.getElementById('current-month-operating-days').textContent = `${days} ì¼`; 
    if(document.getElementById('current-month-trip-count')) document.getElementById('current-month-trip-count').textContent = `${count} ê±´`; 
    if(document.getElementById('current-month-total-mileage')) document.getElementById('current-month-total-mileage').textContent = `${dist.toFixed(1)} km`; 
    if(document.getElementById('current-month-income')) document.getElementById('current-month-income').textContent = `${formatToManwon(inc)} ë§Œì›`; 
    if(document.getElementById('current-month-expense')) document.getElementById('current-month-expense').textContent = `${formatToManwon(exp)} ë§Œì›`; 
    if(document.getElementById('current-month-net-income')) document.getElementById('current-month-net-income').textContent = `${formatToManwon(net)} ë§Œì›`; 
    if(document.getElementById('current-month-avg-economy')) document.getElementById('current-month-avg-economy').textContent = `${avg} km/L`; 
    if(document.getElementById('current-month-cost-per-km')) document.getElementById('current-month-cost-per-km').textContent = `${costKm.toLocaleString()} ì›`; 
    
    const limit = parseFloat(localStorage.getItem("fuel_subsidy_limit")) || 0; 
    const remain = limit - liters; 
    const pct = limit > 0 ? Math.min(100, 100 * liters / limit).toFixed(1) : 0; 
    const subSum = document.getElementById('subsidy-summary');
    if(subSum) subSum.innerHTML = `<div class="progress-label">ì›” í•œë„: ${limit.toLocaleString()} L | ì‚¬ìš©: ${liters.toFixed(1)} L | ì”ì—¬: ${remain.toFixed(1)} L</div><div class="progress-bar-container"><div class="progress-bar progress-bar-used" style="width: ${pct}%;"></div></div>`; 
}

function displayCumulativeData() {
    const records = MEM_RECORDS.filter(r => r.type !== 'ìš´í–‰ì·¨ì†Œ' && r.type !== 'ìš´í–‰ì¢…ë£Œ');
    let inc = 0, exp = 0, count = 0, dist = 0, liters = 0;
    records.forEach(r => {
        inc += safeInt(r.income); exp += safeInt(r.cost);
        if(r.type === 'ì£¼ìœ ì†Œ') liters += safeFloat(r.liters);
        if(r.type === 'í™”ë¬¼ìš´ì†¡') { count++; dist += safeFloat(r.distance); }
    });
    const correction = parseFloat(localStorage.getItem("mileage_correction")) || 0;
    const totalDist = dist + correction;
    const net = inc - exp;
    const avg = liters > 0 && totalDist > 0 ? (totalDist/liters).toFixed(2) : 0;
    const costKm = totalDist > 0 ? Math.round(exp/totalDist) : 0;
    const days = new Set(records.map(r => getStatisticalDate(r.date, r.time))).size;
    
    if(document.getElementById('cumulative-operating-days')) document.getElementById('cumulative-operating-days').textContent = `${days} ì¼`;
    if(document.getElementById('cumulative-trip-count')) document.getElementById('cumulative-trip-count').textContent = `${count} ê±´`;
    if(document.getElementById('cumulative-total-mileage')) document.getElementById('cumulative-total-mileage').textContent = `${Math.round(totalDist).toLocaleString()} km`;
    if(document.getElementById('cumulative-income')) document.getElementById('cumulative-income').textContent = `${formatToManwon(inc)} ë§Œì›`;
    if(document.getElementById('cumulative-expense')) document.getElementById('cumulative-expense').textContent = `${formatToManwon(exp)} ë§Œì›`;
    if(document.getElementById('cumulative-net-income')) document.getElementById('cumulative-net-income').textContent = `${formatToManwon(net)} ë§Œì›`;
    if(document.getElementById('cumulative-avg-economy')) document.getElementById('cumulative-avg-economy').textContent = `${avg} km/L`;
    if(document.getElementById('cumulative-cost-per-km')) document.getElementById('cumulative-cost-per-km').textContent = `${costKm.toLocaleString()} ì›`;
    renderMileageSummary();
}

function renderMileageSummary(period = 'monthly') {
    const validRecords = MEM_RECORDS.filter(r => ['í™”ë¬¼ìš´ì†¡'].includes(r.type));
    let summaryData = {};
    if (period === 'monthly') {
        for (let i = 11; i >= 0; i--) {
            const d = new Date(); d.setMonth(d.getMonth() - i);
            const k = d.toISOString().slice(0, 7);
            summaryData[k] = 0;
        }
        validRecords.forEach(r => { 
            const statDate = getStatisticalDate(r.date, r.time);
            const k = statDate.substring(0, 7); 
            if (summaryData.hasOwnProperty(k)) summaryData[k]++; 
        });
    } else {
        for (let i = 11; i >= 0; i--) {
            const d = new Date(); d.setDate(d.getDate() - (i * 7));
            const k = d.toISOString().slice(0, 10);
            summaryData[k] = 0;
        }
        validRecords.forEach(r => {
            const statDate = getStatisticalDate(r.date, r.time);
            const d = new Date(statDate); 
            d.setDate(d.getDate() - d.getDay() + 1);
            const k = d.toISOString().slice(0, 10);
            if (summaryData.hasOwnProperty(k)) summaryData[k]++;
        });
    }
    let h = '';
    for (const k in summaryData) {
        h += `<div class="metric-card"><span class="metric-label">${k}</span><span class="metric-value">${summaryData[k]} ê±´</span></div>`;
    }
    if(document.getElementById('mileage-summary-cards')) document.getElementById('mileage-summary-cards').innerHTML = h;
}

function generatePrintView(year, month, period, isDetailed) {
    const sDay = period === 'second' ? 16 : 1;
    const eDay = period === 'first' ? 15 : 31;
    const periodStr = period === 'full' ? '1ì¼ ~ ë§ì¼' : `${sDay}ì¼ ~ ${eDay===15?15:'ë§'}ì¼`;
    
    const target = MEM_RECORDS.filter(r => { 
        const statDate = getStatisticalDate(r.date, r.time);
        const d = new Date(statDate); 
        return statDate.startsWith(`${year}-${month}`) && d.getDate() >= sDay && d.getDate() <= eDay && r.type !== 'ìš´í–‰ì¢…ë£Œ'; 
    }).sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
    
    const transportList = target.filter(r => ['í™”ë¬¼ìš´ì†¡', 'ëŒ€ê¸°', 'ìš´í–‰ì·¨ì†Œ'].includes(r.type));
    const fuelList = target.filter(r => r.type === 'ì£¼ìœ ì†Œ');
    const expenseList = target.filter(r => ['ì§€ì¶œ', 'ì†Œëª¨í’ˆ'].includes(r.type));
    const incomeList = target.filter(r => r.type === 'ìˆ˜ì…');

    let transInc = 0, transExp = 0, transDist = 0;
    transportList.forEach(r => {
        transInc += safeInt(r.income);
        transExp += safeInt(r.cost);
        transDist += safeFloat(r.distance);
    });

    let fuelTotalCost = 0, fuelTotalSubsidy = 0;
    fuelList.forEach(r => {
        fuelTotalCost += safeInt(r.cost);
        fuelTotalSubsidy += safeInt(r.subsidy);
    });
    const fuelNetCost = fuelTotalCost - fuelTotalSubsidy;

    let genExp = 0;
    expenseList.forEach(r => genExp += safeInt(r.cost));

    let genInc = 0;
    incomeList.forEach(r => genInc += safeInt(r.income));

    const totalRevenue = transInc + genInc; 
    const totalSpend = transExp + genExp + fuelNetCost; 
    const finalProfit = totalRevenue - totalSpend; 

    const workDays = new Set(
        transportList.map(r => getStatisticalDate(r.date, r.time))
    ).size;

    const w = window.open('','_blank');
    
    let h = `
    <html>
    <head>
        <title>ìš´ì†¡ë‚´ì—­ì„œ</title>
        <style>
            body { font-family: sans-serif; margin: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; margin-bottom: 20px; }
            th, td { border: 1px solid #ccc; padding: 6px; text-align: center; word-wrap: break-word; }
            th { background: #eee; }
            .summary { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; background-color: #f9f9f9; line-height: 1.6; }
            .date-border { border-top: 2px solid #000 !important; }
            .left-align { text-align: left; padding-left: 5px; }
            .col-date { width: 80px; }
            .col-location { width: 120px; }
            .col-note { width: 100px; }
            h3 { margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 30px; }
            .txt-red { color: #dc3545; font-weight: bold; }
            .txt-blue { color: #007bff; font-weight: bold; }
            .txt-green { color: #28a745; font-weight: bold; }
        </style>
    </head>
    <body>
        <h2>${year}ë…„ ${month}ì›” ${periodStr} ìš´ì†¡ ê¸°ë¡ (04ì‹œ ê¸°ì¤€)</h2>
        
        <div class="summary">
            <p><strong>[ìš”ì•½]</strong> ê·¼ë¬´ì¼: ${workDays}ì¼ | ìš´í–‰ê±´ìˆ˜: ${transportList.length}ê±´ | ìš´í–‰ê±°ë¦¬: ${transDist.toFixed(1)}km</p>
            <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">
            <p><span class="txt-blue">[ + ] ì´ ìˆ˜ì…: ${totalRevenue.toLocaleString()} ì›</span> (ìš´ì†¡: ${transInc.toLocaleString()} + ê¸°íƒ€: ${genInc.toLocaleString()})</p>
            <p><span class="txt-red">[ - ] ì´ ì§€ì¶œ: ${(transExp + genExp).toLocaleString()} ì›</span> (ìš´ì†¡ì§€ì¶œ: ${transExp.toLocaleString()} + ì¼ë°˜ì§€ì¶œ: ${genExp.toLocaleString()})</p>
            <p><span class="txt-red">[ - ] ì‹¤ ì£¼ìœ ë¹„: ${fuelNetCost.toLocaleString()} ì›</span> (ì£¼ìœ ê¸ˆì•¡: ${fuelTotalCost.toLocaleString()} - ë³´ì¡°ê¸ˆ: ${fuelTotalSubsidy.toLocaleString()})</p>
            <hr style="border:0; border-top:2px solid #333; margin:10px 0;">
            <p class="txt-green" style="font-size: 1.4em;">[ = ] ìµœì¢… ìˆœìˆ˜ìµ: ${finalProfit.toLocaleString()} ì›</p>
        </div>

        <h3>1. ìš´ì†¡ ë‚´ì—­</h3>
        <table>
            <thead>
                <tr>
                    <th class="col-date">ë‚ ì§œ</th>
                    <th class="col-location">ìƒì°¨ì§€</th>
                    <th class="col-location">í•˜ì°¨ì§€</th>
                    <th class="col-note">ë‚´ìš©</th>
                    ${isDetailed ? '<th>ê±°ë¦¬</th><th>ìˆ˜ì…</th>' : ''}
                </tr>
            </thead>
            <tbody>`;
            
    if (transportList.length === 0) h += `<tr><td colspan="${isDetailed?6:4}">ë‚´ì—­ ì—†ìŒ</td></tr>`;
    
    let lastDate = '';
    transportList.forEach(r => {
        const statDate = getStatisticalDate(r.date, r.time);
        let borderClass = ''; 
        if(lastDate !== '' && lastDate !== statDate) borderClass = 'class="date-border"'; 
        lastDate = statDate;

        let dateDisplay = statDate.substring(5);
        let from = r.from || '';
        let to = r.to || '';
        let desc = r.type;
        if(r.type === 'ëŒ€ê¸°') desc = 'ëŒ€ê¸°';
        if(r.type === 'ìš´í–‰ì·¨ì†Œ') desc = 'ì·¨ì†Œ';

        h += `<tr ${borderClass}>
                <td>${dateDisplay}</td>
                <td class="left-align">${from}</td>
                <td class="left-align">${to}</td>
                <td>${desc}</td>
                ${isDetailed ? `<td>${safeFloat(r.distance)||'-'}</td><td>${safeInt(r.income).toLocaleString()}</td>` : ''}
              </tr>`;
    });
    h += `</tbody></table>`;

    h += `<h3>2. ì£¼ìœ  ë° ì •ë¹„ ë‚´ì—­</h3>`;
    if (fuelList.length > 0) {
        h += `<table>
                <thead>
                    <tr>
                        <th class="col-date">ë‚ ì§œ</th>
                        <th>ì£¼ìœ ë¦¬í„°</th>
                        <th>ì£¼ìœ ë‹¨ê°€</th>
                        <th>ì£¼ìœ ê¸ˆì•¡</th>
                        <th>ë³´ì¡°ê¸ˆì•¡</th>
                        <th>ì‹¤ê²°ì œê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>`;
        
        fuelList.forEach(r => {
             const statDate = getStatisticalDate(r.date, r.time);
             let dateDisplay = statDate.substring(5);
             if(r.date !== statDate) dateDisplay += ' (ìµì¼)';
             
             const cost = safeInt(r.cost);
             const subsidy = safeInt(r.subsidy);
             const netCost = cost - subsidy;

             h += `<tr>
                    <td>${dateDisplay}</td>
                    <td>${safeFloat(r.liters).toFixed(2)} L</td>
                    <td>${safeInt(r.unitPrice).toLocaleString()} ì›</td>
                    <td>${cost.toLocaleString()} ì›</td>
                    <td style="color:red;">${subsidy > 0 ? '-' + subsidy.toLocaleString() : '0'} ì›</td>
                    <td style="font-weight:bold;">${netCost.toLocaleString()} ì›</td>
                   </tr>`;
        });
        h += `</tbody></table>`;
    } else {
        h += `<p>ë‚´ì—­ ì—†ìŒ</p>`;
    }

    h += `<h3>3. ì§€ì¶œ ë‚´ì—­</h3>`;
    if (expenseList.length > 0) {
        h += `<table>
                <thead>
                    <tr>
                        <th class="col-date">ë‚ ì§œ</th>
                        <th>ë‚´ìš© (ì ìš”)</th>
                        <th>ì§€ì¶œê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>`;
        expenseList.forEach(r => {
            const statDate = getStatisticalDate(r.date, r.time);
            let dateDisplay = statDate.substring(5);
            let item = r.expenseItem || r.supplyItem || r.type;
            
            h += `<tr>
                    <td>${dateDisplay}</td>
                    <td class="left-align">${item}</td>
                    <td>${safeInt(r.cost).toLocaleString()} ì›</td>
                  </tr>`;
        });
        h += `</tbody></table>`;
    } else {
        h += `<p>ë‚´ì—­ ì—†ìŒ</p>`;
    }

    h += `<h3>4. ìˆ˜ì… ë‚´ì—­</h3>`;
    if (incomeList.length > 0) {
        h += `<table>
                <thead>
                    <tr>
                        <th class="col-date">ë‚ ì§œ</th>
                        <th>ë‚´ìš© (ì ìš”)</th>
                        <th>ìˆ˜ì…ê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>`;
        incomeList.forEach(r => {
            const statDate = getStatisticalDate(r.date, r.time);
            let dateDisplay = statDate.substring(5);
            let item = r.expenseItem || r.type; 
            
            h += `<tr>
                    <td>${dateDisplay}</td>
                    <td class="left-align">${item}</td>
                    <td>${safeInt(r.income).toLocaleString()} ì›</td>
                  </tr>`;
        });
        h += `</tbody></table>`;
    } else {
        h += `<p>ë‚´ì—­ ì—†ìŒ</p>`;
    }

    h += `<button onclick="window.print()" style="padding:10px 20px; font-size:1.2em; cursor:pointer;">ì¸ì‡„í•˜ê¸°</button>
    </body>
    </html>`;
    
    w.document.write(h); 
    w.document.close();
}

// ========================
// 4. UI Logic (ui.js / main.js combined)
// ========================

function toggleUI() {
    const typeSelect = document.getElementById('type');
    const editMode = document.getElementById('edit-mode-indicator');
    if(!typeSelect || !editMode) return;

    const type = typeSelect.value;
    const isEditMode = !editMode.classList.contains('hidden');

    ['transport-details', 'fuel-details', 'supply-details', 'expense-details', 'cost-info-fieldset', 'trip-actions', 'general-actions', 'edit-actions'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
    });
    
    const costWrapper = document.getElementById('cost-wrapper');
    const incomeWrapper = document.getElementById('income-wrapper');
    const btnTripCancel = document.getElementById('btn-trip-cancel');

    if (type === 'í™”ë¬¼ìš´ì†¡' || type === 'ëŒ€ê¸°') {
        document.getElementById('transport-details').classList.remove('hidden');
        document.getElementById('cost-info-fieldset').classList.remove('hidden');
        if(costWrapper) costWrapper.classList.add('hidden');
        if(incomeWrapper) incomeWrapper.classList.remove('hidden');
        if (!isEditMode) {
            document.getElementById('trip-actions').classList.remove('hidden');
            if(type === 'í™”ë¬¼ìš´ì†¡' && btnTripCancel) btnTripCancel.classList.remove('hidden');
        }
    } else if (type === 'ìˆ˜ì…') {
        document.getElementById('expense-details').classList.remove('hidden'); 
        document.getElementById('expense-legend').textContent = "ìˆ˜ì… ë‚´ì—­";
        document.getElementById('cost-info-fieldset').classList.remove('hidden');
        if(incomeWrapper) incomeWrapper.classList.remove('hidden');
        if(costWrapper) costWrapper.classList.add('hidden');
        if (!isEditMode) document.getElementById('general-actions').classList.remove('hidden');
    } else {
        document.getElementById('cost-info-fieldset').classList.remove('hidden');
        if(incomeWrapper) incomeWrapper.classList.add('hidden');
        if(costWrapper) costWrapper.classList.remove('hidden');
        
        if (type === 'ì£¼ìœ ì†Œ') {
            document.getElementById('fuel-details').classList.remove('hidden');
            if (!isEditMode) document.getElementById('general-actions').classList.remove('hidden');
        } else if (type === 'ì†Œëª¨í’ˆ') {
            document.getElementById('supply-details').classList.remove('hidden');
            if (!isEditMode) document.getElementById('general-actions').classList.remove('hidden');
        } else if (type === 'ì§€ì¶œ') {
            document.getElementById('expense-details').classList.remove('hidden');
            document.getElementById('expense-legend').textContent = "ì§€ì¶œ ë‚´ì—­";
            if (!isEditMode) document.getElementById('general-actions').classList.remove('hidden');
        }
    }

    if (isEditMode) {
        document.getElementById('edit-actions').classList.remove('hidden');
        const btnEditEnd = document.getElementById('btn-edit-end-trip');
        const btnEditStart = document.getElementById('btn-edit-start-trip');
        
        if (type === 'ì£¼ìœ ì†Œ' || type === 'ì†Œëª¨í’ˆ' || type === 'ì§€ì¶œ' || type === 'ìˆ˜ì…') {
            if(btnEditEnd) btnEditEnd.classList.add('hidden');
            if(btnEditStart) btnEditStart.classList.add('hidden');
        } else {
            if(btnEditEnd) btnEditEnd.classList.remove('hidden');
            if(btnEditStart) btnEditStart.classList.remove('hidden');
        }
    }
}

function getFormDataWithoutTime() {
    const fromCenter = document.getElementById('from-center');
    const toCenter = document.getElementById('to-center');
    const fromValue = fromCenter ? fromCenter.value.trim() : '';
    const toValue = toCenter ? toCenter.value.trim() : '';
    
    if(fromValue) updateLocationData(fromValue);
    if(toValue) updateLocationData(toValue);

    return {
        type: document.getElementById('type').value,
        from: fromValue,
        to: toValue,
        distance: parseFloat(document.getElementById('manual-distance').value) || 0,
        cost: Math.round((parseFloat(document.getElementById('cost').value) || 0) * 10000),
        income: Math.round((parseFloat(document.getElementById('income').value) || 0) * 10000),
        liters: parseFloat(document.getElementById('fuel-liters').value) || 0,
        unitPrice: parseInt(document.getElementById('fuel-unit-price').value) || 0,
        brand: document.getElementById('fuel-brand').value || '',
        supplyItem: document.getElementById('supply-item').value || '',
        mileage: parseInt(document.getElementById('supply-mileage').value) || 0,
        expenseItem: document.getElementById('expense-item').value || ''
    };
}

function resetForm() {
    document.getElementById('record-form').reset();
    document.getElementById('edit-id').value = '';
    document.getElementById('edit-mode-indicator').classList.add('hidden');
    document.getElementById('date').value = getTodayString();
    document.getElementById('time').value = getCurrentTimeString();
    document.getElementById('date').disabled = false;
    document.getElementById('time').disabled = false;
    document.getElementById('address-display').innerHTML = '';
    toggleUI();
}

function updateAddressDisplay() {
    const fromValue = document.getElementById('from-center').value;
    const toValue = document.getElementById('to-center').value;
    const fromLoc = MEM_LOCATIONS[fromValue] || {};
    const toLoc = MEM_LOCATIONS[toValue] || {};
    let html = '';
    if (fromLoc.address) html += `<div class="address-clickable" data-address="${fromLoc.address}">[ìƒ] ${fromLoc.address}</div>`;
    if (fromLoc.memo) html += `<div class="memo-display">[ìƒ] ${fromLoc.memo}</div>`;
    if (toLoc.address) html += `<div class="address-clickable" data-address="${toLoc.address}">[í•˜] ${toLoc.address}</div>`;
    if (toLoc.memo) html += `<div class="memo-display">[í•˜] ${toLoc.memo}</div>`;
    document.getElementById('address-display').innerHTML = html;
}

function populateCenterDatalist() {
    document.getElementById('center-list').innerHTML = MEM_CENTERS.map(c => `<option value="${c}"></option>`).join('');
}
function populateExpenseDatalist() {
    document.getElementById('expense-list').innerHTML = MEM_EXPENSE_ITEMS.map(item => `<option value="${item}"></option>`).join('');
}

function displayCenterList(filter='') {
    const container = document.getElementById('center-list-container');
    if(!container) return;
    container.innerHTML = "";
    const list = MEM_CENTERS.filter(c => c.includes(filter));
    if(list.length===0) { container.innerHTML='<p class="note">ê²°ê³¼ ì—†ìŒ</p>'; return; } 
    list.forEach(c => {
        const l = MEM_LOCATIONS[c]||{};
        const div = document.createElement('div');
        div.className='center-item';
        div.innerHTML=`<div class="info"><span class="center-name">${c}</span><div class="action-buttons"><button class="edit-btn">ìˆ˜ì •</button><button class="delete-btn">ì‚­ì œ</button></div></div>${l.address?`<span class="note">ì£¼ì†Œ: ${l.address}</span>`:''}`;
        div.querySelector('.edit-btn').onclick = () => {
            div.innerHTML = `<div class="edit-form"><input class="edit-input" value="${c}"><input class="edit-address-input" value="${l.address||''}"><input class="edit-memo-input" value="${l.memo||''}"><div class="action-buttons"><button class="setting-save-btn">ì €ì¥</button><button class="cancel-edit-btn">ì·¨ì†Œ</button></div></div>`;
            div.querySelector('.setting-save-btn').onclick = () => {
                const nn = div.querySelector('.edit-input').value.trim();
                const na = div.querySelector('.edit-address-input').value.trim();
                const nm = div.querySelector('.edit-memo-input').value.trim();
                if(nn && nn!==c) {
                    const idx = MEM_CENTERS.indexOf(c); if(idx>-1) MEM_CENTERS.splice(idx,1);
                    if(!MEM_CENTERS.includes(nn)) MEM_CENTERS.push(nn);
                    delete MEM_LOCATIONS[c];
                    MEM_RECORDS.forEach(r => { if(r.from===c) r.from=nn; if(r.to===c) r.to=nn; });
                    MEM_CENTERS.sort(); saveData();
                }
                updateLocationData(nn, na, nm);
                displayCenterList(document.getElementById('center-search-input').value);
            };
            div.querySelector('.cancel-edit-btn').onclick = () => displayCenterList(document.getElementById('center-search-input').value);
        };
        div.querySelector('.delete-btn').onclick = () => {
            if(confirm('ì‚­ì œ?')) {
                const idx = MEM_CENTERS.indexOf(c);
                if(idx>-1) MEM_CENTERS.splice(idx,1);
                delete MEM_LOCATIONS[c];
                saveData();
                displayCenterList(document.getElementById('center-search-input').value);
            }
        };
        container.appendChild(div);
    });
}

// 2ì£¼ê°„ ìì£¼ ë°©ë¬¸í•œ ì¥ì†Œ ë²„íŠ¼
function renderFrequentLocationButtons() {
    const fromContainer = document.getElementById('top-from-centers');
    const toContainer = document.getElementById('top-to-centers');
    if (!fromContainer || !toContainer) return;

    const twoWeeksAgo = new Date();
    twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
    const fromCounts = {}, toCounts = {};

    MEM_RECORDS.forEach(r => {
        const recordDate = new Date(r.date);
        if ((r.type === 'í™”ë¬¼ìš´ì†¡' || r.type === 'ëŒ€ê¸°') && recordDate >= twoWeeksAgo) {
            if (r.from) fromCounts[r.from] = (fromCounts[r.from] || 0) + 1;
            if (r.to) toCounts[r.to] = (toCounts[r.to] || 0) + 1;
        }
    });

    const topFrom = Object.entries(fromCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
    const topTo = Object.entries(toCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

    const buildButtons = (data, container, targetId) => {
        container.innerHTML = '';
        data.forEach(([name]) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'quick-loc-btn';
            btn.textContent = name;
            btn.onclick = () => {
                const input = document.getElementById(targetId);
                input.value = name;
                input.dispatchEvent(new Event('input'));
            };
            container.appendChild(btn);
        });
    };
    buildButtons(topFrom, fromContainer, 'from-center');
    buildButtons(topTo, toContainer, 'to-center');
}

window.viewDateDetails = function(date) { 
    document.getElementById('today-date-picker').value = date; 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove("active")); 
    document.querySelector('.tab-btn[data-view="today"]').classList.add("active"); 
    document.querySelectorAll('.view-content').forEach(c => c.classList.remove('active')); 
    document.getElementById("today-view").classList.add("active"); 
    displayTodayRecords(date); 
};

window.toggleAllSummaryValues = function(gridElement) { 
    const items = gridElement.querySelectorAll('.summary-item'); 
    const isShowing = gridElement.classList.toggle('active'); 
    items.forEach(item => { 
        const valueEl = item.querySelector('.summary-value'); 
        if(isShowing) { item.classList.add('active'); valueEl.classList.remove('hidden'); } 
        else { item.classList.remove('active'); valueEl.classList.add('hidden'); } 
    }); 
};

window.editRecord = function(id) {
    const r = MEM_RECORDS.find(x => x.id === id);
    if(!r) return;
    document.getElementById('date').value = r.date; 
    document.getElementById('time').value = r.time; 
    document.getElementById('type').value = r.type;
    document.getElementById('from-center').value = r.from || ''; 
    document.getElementById('to-center').value = r.to || '';
    document.getElementById('manual-distance').value = r.distance || ''; 
    document.getElementById('income').value = r.income ? (r.income/10000) : ''; 
    document.getElementById('cost').value = r.cost ? (r.cost/10000) : '';
    document.getElementById('fuel-brand').value = r.brand || ''; 
    document.getElementById('fuel-liters').value = r.liters || ''; 
    document.getElementById('fuel-unit-price').value = r.unitPrice || '';
    document.getElementById('expense-item').value = r.expenseItem || ''; 
    document.getElementById('supply-item').value = r.supplyItem || ''; 
    document.getElementById('supply-mileage').value = r.mileage || '';
    document.getElementById('edit-id').value = id; 
    document.getElementById('edit-mode-indicator').classList.remove('hidden');
    document.getElementById('date').disabled = true; 
    document.getElementById('time').disabled = true;
    toggleUI(); 
    window.scrollTo(0,0);
}

// ========================
// 5. INITIALIZATION & EVENTS
// ========================

function initialSetup() {
    loadAllData();
    populateCenterDatalist();
    populateExpenseDatalist();
    
    // ì—°ë„/ì›” ì´ˆê¸°í™”
    const y = new Date().getFullYear();
    const yrs = []; for(let i=0; i<5; i++) yrs.push(`<option value="${y-i}">${y-i}ë…„</option>`);
    ['daily-year-select', 'weekly-year-select', 'monthly-year-select', 'print-year-select'].forEach(id => {
        const el = document.getElementById(id); if(el) el.innerHTML = yrs.join('');
    });
    const ms = []; for(let i=1; i<=12; i++) ms.push(`<option value="${i.toString().padStart(2,'0')}">${i}ì›”</option>`);
    ['daily-month-select', 'weekly-month-select', 'print-month-select'].forEach(id => {
        const el = document.getElementById(id); if(el) { el.innerHTML = ms.join(''); el.value = (new Date().getMonth()+1).toString().padStart(2,'0'); }
    });

    const mC = document.getElementById('mileage-correction'); if(mC) mC.value = localStorage.getItem('mileage_correction') || 0;
    const sL = document.getElementById('subsidy-limit'); if(sL) sL.value = localStorage.getItem('fuel_subsidy_limit') || 0;
    
    const todayStr = getTodayString();
    const nowTime = getCurrentTimeString();
    document.getElementById('today-date-picker').value = getStatisticalDate(todayStr, nowTime);

    resetForm();
    updateAllDisplays();
    setupEventListeners();
}

function updateAllDisplays() {
    const targetDate = document.getElementById('today-date-picker').value;
    displayTodayRecords(targetDate);
    displayDailyRecords();
    displayWeeklyRecords();
    displayMonthlyRecords();
    renderFrequentLocationButtons();
}

function setupEventListeners() {
    // ìš´í–‰ ë“±ë¡ (ì‹œê°„ ë¯¸ì…ë ¥ ì‹œ í˜„ì¬ í¼ ê°’ ìœ ì§€)
    document.getElementById('btn-register-trip')?.addEventListener('click', () => {
        const formData = getFormDataWithoutTime();
        if (formData.type === 'í™”ë¬¼ìš´ì†¡' && formData.distance <= 0) { alert('ìš´í–‰ê±°ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        addRecord({ 
            id: Date.now(), 
            date: document.getElementById('date').value, 
            time: document.getElementById('time').value, 
            ...formData 
        });
        showToast('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        resetForm();
        updateAllDisplays();
    });

    // ìš´í–‰ ì‹œì‘ (GPS ì‹œê°„ ê°•ì œ)
    document.getElementById('btn-start-trip')?.addEventListener('click', () => {
        const formData = getFormDataWithoutTime();
        if (formData.type === 'í™”ë¬¼ìš´ì†¡' && formData.distance <= 0) { alert('ìš´í–‰ê±°ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        addRecord({ id: Date.now(), date: getTodayString(), time: getCurrentTimeString(), ...formData });
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        resetForm();
        document.getElementById('today-date-picker').value = getStatisticalDate(getTodayString(), getCurrentTimeString());
        updateAllDisplays();
    });

    // ìš´í–‰ ì¢…ë£Œ (GPS ì‹œê°„ ê°•ì œ)
    document.getElementById('btn-end-trip')?.addEventListener('click', () => {
        addRecord({ id: Date.now(), date: getTodayString(), time: getCurrentTimeString(), type: 'ìš´í–‰ì¢…ë£Œ', distance: 0, cost: 0, income: 0 });
        showToast('ìš´í–‰ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        resetForm();
        document.getElementById('today-date-picker').value = getStatisticalDate(getTodayString(), getCurrentTimeString());
        updateAllDisplays();
    });

    // ìš´í–‰ ì·¨ì†Œ
    document.getElementById('btn-trip-cancel')?.addEventListener('click', () => {
        const formData = getFormDataWithoutTime();
        addRecord({ id: Date.now(), date: getTodayString(), time: getCurrentTimeString(), ...formData, type: 'ìš´í–‰ì·¨ì†Œ' });
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        resetForm();
        document.getElementById('today-date-picker').value = getStatisticalDate(getTodayString(), getCurrentTimeString());
        updateAllDisplays();
    });

    // ì¼ë°˜ ì €ì¥
    document.getElementById('btn-save-general')?.addEventListener('click', () => {
        const formData = getFormDataWithoutTime();
        if (formData.type === 'í™”ë¬¼ìš´ì†¡' && formData.distance <= 0) { alert('ìš´í–‰ê±°ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        if (formData.type === 'ì§€ì¶œ' || formData.type === 'ìˆ˜ì…') { if (formData.expenseItem) updateExpenseItemData(formData.expenseItem); }
        addRecord({ id: Date.now(), date: document.getElementById('date').value, time: document.getElementById('time').value, ...formData });
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        populateExpenseDatalist();
        document.getElementById('today-date-picker').value = getStatisticalDate(document.getElementById('date').value, document.getElementById('time').value);
        resetForm();
        updateAllDisplays();
        if(formData.type === 'ì£¼ìœ ì†Œ') displaySubsidyRecords();
    });

    // ìˆ˜ì • ì™„ë£Œ
    document.getElementById('btn-update-record')?.addEventListener('click', () => {
        const id = parseInt(document.getElementById('edit-id').value);
        const index = MEM_RECORDS.findIndex(r => r.id === id);
        if (index > -1) {
            const original = MEM_RECORDS[index];
            const formData = getFormDataWithoutTime();
            if (formData.type === 'í™”ë¬¼ìš´ì†¡' && formData.from && formData.to) {
                const key = `${formData.from}-${formData.to}`;
                if(formData.distance > 0) MEM_DISTANCES[key] = formData.distance;
                if(formData.income > 0) MEM_FARES[key] = formData.income;
            }
            if (formData.type === 'ì§€ì¶œ' || formData.type === 'ìˆ˜ì…') { if (formData.expenseItem) updateExpenseItemData(formData.expenseItem); }
            MEM_RECORDS[index] = { ...original, ...formData, date: original.date, time: original.time }; // ì‹œê°„ ìœ ì§€
            saveData();
            populateExpenseDatalist();
            showToast('ìˆ˜ì • ì™„ë£Œ.');
            document.getElementById('today-date-picker').value = getStatisticalDate(original.date, original.time);
            resetForm();
            updateAllDisplays();
            if(formData.type === 'ì£¼ìœ ì†Œ') displaySubsidyRecords();
        }
    });

    // í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ìš´í–‰ ì‹œì‘ (ìˆ˜ì • ëª¨ë“œ) [ì¶”ê°€]
    document.getElementById('btn-edit-start-trip')?.addEventListener('click', () => {
        const nowTime = getCurrentTimeString();
        const nowDate = getTodayString();
        const id = parseInt(document.getElementById('edit-id').value);
        const index = MEM_RECORDS.findIndex(r => r.id === id);
        if (index > -1) {
            MEM_RECORDS[index].date = nowDate;
            MEM_RECORDS[index].time = nowTime;
            saveData();
            showToast('ì‹œì‘ ì‹œê°„ì´ í˜„ì¬ë¡œ ì—…ë°ì´íŠ¸ë¨.');
            resetForm();
            document.getElementById('today-date-picker').value = getStatisticalDate(nowDate, nowTime);
            updateAllDisplays();
        }
    });

    // í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ìš´í–‰ ì¢…ë£Œ (ìˆ˜ì • ëª¨ë“œ)
    document.getElementById('btn-edit-end-trip')?.addEventListener('click', () => {
        const nowTime = getCurrentTimeString();
        const nowDate = getTodayString();
        const id = parseInt(document.getElementById('edit-id').value);
        const index = MEM_RECORDS.findIndex(r => r.id === id);
        if (index > -1 && MEM_RECORDS[index].type === 'ìš´í–‰ì¢…ë£Œ') {
            MEM_RECORDS[index].date = nowDate;
            MEM_RECORDS[index].time = nowTime;
            showToast('ì¢…ë£Œ ì‹œê°„ì´ í˜„ì¬ë¡œ ì—…ë°ì´íŠ¸ë¨.');
        } else {
            addRecord({ id: Date.now(), date: nowDate, time: nowTime, type: 'ìš´í–‰ì¢…ë£Œ', distance: 0, cost: 0, income: 0 });
            showToast('ìš´í–‰ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        saveData();
        resetForm();
        document.getElementById('today-date-picker').value = getStatisticalDate(nowDate, nowTime);
        updateAllDisplays();
    });

    // ì‚­ì œ
    document.getElementById('btn-delete-record')?.addEventListener('click', () => {
        if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            const id = parseInt(document.getElementById('edit-id').value);
            const target = MEM_RECORDS.find(r => r.id === id);
            let stayDate = document.getElementById('today-date-picker').value;
            if(target) stayDate = getStatisticalDate(target.date, target.time);
            removeRecord(id);
            resetForm();
            document.getElementById('today-date-picker').value = stayDate;
            updateAllDisplays();
        }
    });

    document.getElementById('btn-cancel-edit')?.addEventListener('click', resetForm);
    document.getElementById('refresh-btn')?.addEventListener('click', () => { resetForm(); location.reload(); });
    
    document.getElementById('today-date-picker')?.addEventListener('change', () => updateAllDisplays());
    
    document.getElementById('prev-day-btn')?.addEventListener('click', () => {
        const picker = document.getElementById('today-date-picker');
        const parts = picker.value.split('-').map(Number);
        const dateObj = new Date(parts[0], parts[1] - 1, parts[2] - 1);
        picker.value = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
        updateAllDisplays();
    });
    
    document.getElementById('next-day-btn')?.addEventListener('click', () => {
        const picker = document.getElementById('today-date-picker');
        const parts = picker.value.split('-').map(Number);
        const dateObj = new Date(parts[0], parts[1] - 1, parts[2] + 1);
        picker.value = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
        updateAllDisplays();
    });

    // ì…ë ¥ í•„ë“œ ìë™ì™„ì„±
    ['from-center', 'to-center'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', () => {
            const from = document.getElementById('from-center').value.trim();
            const to = document.getElementById('to-center').value.trim();
            if((document.getElementById('type').value === 'í™”ë¬¼ìš´ì†¡' || document.getElementById('type').value === 'ëŒ€ê¸°') && from && to) {
                const key = `${from}-${to}`;
                if(MEM_FARES[key]) document.getElementById('income').value = (MEM_FARES[key]/10000).toFixed(2);
                if(MEM_DISTANCES[key]) document.getElementById('manual-distance').value = MEM_DISTANCES[key];
                if(MEM_COSTS[key]) document.getElementById('cost').value = (MEM_COSTS[key]/10000).toFixed(2);
            }
            updateAddressDisplay();
        });
    });

    document.getElementById('fuel-unit-price')?.addEventListener('input', () => { 
        const p=parseFloat(document.getElementById('fuel-unit-price').value)||0; 
        const l=parseFloat(document.getElementById('fuel-liters').value)||0; 
        if(p&&l) document.getElementById('cost').value=(p*l/10000).toFixed(2); 
    });
    document.getElementById('fuel-liters')?.addEventListener('input', () => { 
        const p=parseFloat(document.getElementById('fuel-unit-price').value)||0; 
        const l=parseFloat(document.getElementById('fuel-liters').value)||0; 
        if(p&&l) document.getElementById('cost').value=(p*l/10000).toFixed(2); 
    });
    
    document.getElementById('type')?.addEventListener('change', toggleUI);
    
    // íƒ­ ì „í™˜
    document.querySelectorAll('.tab-btn').forEach(btn => { 
        btn.addEventListener("click", event => { 
            if(btn.parentElement.classList.contains('view-tabs')) { 
                event.preventDefault(); 
                document.querySelectorAll('.tab-btn').forEach(b => { if(b.parentElement.classList.contains('view-tabs')) b.classList.remove("active"); }); 
                btn.classList.add("active"); 
                document.querySelectorAll('.view-content').forEach(c => c.classList.remove('active')); 
                document.getElementById(btn.dataset.view + "-view").classList.add("active"); 
                updateAllDisplays(); 
            } 
        });
    });

    // ì„¤ì • í˜ì´ì§€ í† ê¸€
    const mainPage = document.getElementById('main-page');
    const settingsPage = document.getElementById('settings-page');
    const goToSettingsBtn = document.getElementById('go-to-settings-btn');
    const backToMainBtn = document.getElementById('back-to-main-btn');

    goToSettingsBtn?.addEventListener("click", () => { 
        mainPage.classList.add("hidden"); 
        settingsPage.classList.remove("hidden"); 
        goToSettingsBtn.classList.add("hidden"); 
        backToMainBtn.classList.remove("hidden"); 
        displayCumulativeData(); 
        displayCurrentMonthData(); 
    });
    backToMainBtn?.addEventListener("click", () => { 
        mainPage.classList.remove("hidden"); 
        settingsPage.classList.add("hidden"); 
        goToSettingsBtn.classList.remove("hidden"); 
        backToMainBtn.classList.add("hidden"); 
        updateAllDisplays(); 
    });

    // ì•„ì½”ë””ì–¸ ë©”ë‰´
    document.querySelectorAll('.collapsible-header').forEach(header => { 
        header.addEventListener("click", () => { 
            const body = header.nextElementSibling; 
            header.classList.toggle("active"); 
            body.classList.toggle("hidden"); 
            if (header.id === 'toggle-subsidy-management' && !body.classList.contains('hidden')) displaySubsidyRecords(false); 
            if (header.id === 'toggle-center-management' && !body.classList.contains('hidden')) displayCenterList();
        }); 
    });
    
    // ì„¤ì • ì €ì¥ ë“± ê¸°íƒ€ ì´ë²¤íŠ¸ë“¤
    document.getElementById('subsidy-save-btn')?.addEventListener('click', () => { localStorage.setItem('fuel_subsidy_limit', document.getElementById('subsidy-limit').value); showToast('ì €ì¥ë¨'); });
    document.getElementById('mileage-correction-save-btn')?.addEventListener('click', () => { localStorage.setItem('mileage_correction', document.getElementById('mileage-correction').value); showToast('ì €ì¥ë¨'); displayCumulativeData(); });
    
    // ë°ì´í„° ë°±ì—…/ë³µì›
    document.getElementById('export-json-btn')?.addEventListener('click', () => { 
        const data = { records: MEM_RECORDS, centers: MEM_CENTERS, locations: MEM_LOCATIONS, fares: MEM_FARES, distances: MEM_DISTANCES, costs: MEM_COSTS, subsidy: localStorage.getItem('fuel_subsidy_limit'), correction: localStorage.getItem('mileage_correction'), expenseItems: MEM_EXPENSE_ITEMS }; 
        const b = new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); 
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download=`backup_${getTodayString()}.json`; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a); 
    });
    document.getElementById('import-json-btn')?.addEventListener('click', () => document.getElementById('import-file-input').click());
    document.getElementById('import-file-input')?.addEventListener('change', (e) => { 
        if(!confirm('ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?')) return; 
        const r = new FileReader(); 
        r.onload = (evt) => { 
            const d = JSON.parse(evt.target.result); 
            if(d.records) localStorage.setItem('records', JSON.stringify(d.records)); 
            if(d.centers) localStorage.setItem('logistics_centers', JSON.stringify(d.centers)); 
            if(d.locations) localStorage.setItem('saved_locations', JSON.stringify(d.locations)); 
            if(d.fares) localStorage.setItem('saved_fares', JSON.stringify(d.fares)); 
            if(d.distances) localStorage.setItem('saved_distances', JSON.stringify(d.distances)); 
            if(d.costs) localStorage.setItem('saved_costs', JSON.stringify(d.costs)); 
            if(d.subsidy) localStorage.setItem('fuel_subsidy_limit', d.subsidy); 
            if(d.correction) localStorage.setItem('mileage_correction', d.correction); 
            if(d.expenseItems) localStorage.setItem('saved_expense_items', JSON.stringify(d.expenseItems));
            alert('ë³µì›ì™„ë£Œ'); location.reload(); 
        }; 
        r.readAsText(e.target.files[0]); 
    });
    document.getElementById('clear-btn')?.addEventListener('click', () => { if(confirm('ì „ì²´ì‚­ì œ?')) { localStorage.clear(); location.reload(); }});
}

document.addEventListener("DOMContentLoaded", initialSetup);
</script>
</body>
</html>